# 通过域名和HTTPS协议访问后台服务API的配置

这篇文档旨在记录通过域名访问后台服务API的配置过程。

场景：

1. 在前端桌面程序/APP/小程序/Web页面的开发过程中，测试阶段一般通过IP地址+端口号访问后台服务API，比如：http://121.40.95.196:8001/project/settings。准备正式上线了，包括发布微信小程序体验版，需要改成通过HTTPS+域名访问后台服务API（微信小程序体验版和正式版都不支持IP地址访问，也不支持HTTP+域名访问），比如：https://api.atai.biz/project/settings

2. 后台服务部署在阿里云的ECS中，IP地址+端口号访问正常

3. 已在阿里云完成域名的注册和备案：atai.biz

4. 使用阿里云的应用型负载均衡ALB

5. 使用阿里云的个人测试证书（原免费证书）

整个配置过程如下：

Step 1: 创建数字证书

在阿里云的数字证书管理服务管理控制台/证书管理/SSL证书管理，选择个人测试证书（原免费证书），点击“立即购买”，在随后的页面中，证书类型选择“个人测试证书（免费版）”，点击“立即购买”，每个账号每年有20个免费额度。

在阿里云的数字证书管理服务管理控制台/证书管理/SSL证书管理，选择个人测试证书（原免费证书），点击“创建证书”，输入域名：api.atai.biz，数量为1.

页面刷新之后，会看到证书列表的第一行出现了刚创建的证书，点击“提交审核”，证书状态变为“审核中”，几分钟后，再变为“已签发”。

通过以上步骤，即完成数字证书的创建，注意免费证书的有效期为3个月。

Step 2：创建ALB实例

在阿里云的负载均衡管理控制台/负载均衡SLB/应用型负载均衡ALB/实例，点击“创建应用型负载均衡”。在随后页面中，地域选择华东1（杭州），实例网络类型选择公网，VPC选择已有的或者新建一个，可用区选择两个（比如H和I），每个可用区选择已有的交换机或者新建一个，实例名称为alb-atai-shared-service。

接下来创建服务器组，名称为atai-shared-service，VPC同前面创建的ALB，后端协议为HTTP，调度算法为加权轮询，健康检查先关掉。

接下来创建监听，名称为默认（协议_端口），监听协议为HTTPS，监听端口为443，服务器组选择刚刚创建的atai-shared-service。数字证书选择Step 1中创建的数字证书。

通过以上步骤，即完成ALB实例的创建，复制该ALB实例的DNS名称。

Step 3：配置域名解析

在阿里云的域名控制台，从域名列表找到atai.biz，在右侧操作中选择“解析”。

进入云解析DNS/公网DNS解析/权威域名解析，在“解析设置”下，点击“添加记录”，在随后的页面中，记录类型选择CNAME，主机记录为api.atai.biz，解析请求来源为默认，记录值为Step 2中复制的ALB实例的DNS名称，TTL使用推荐值10。


经过以上3个步骤，通过域名和HTTPS协议访问后台服务API配置成功。

总结一下，整个访问路径是：1）域名解析，解析到ALB实例；2）ALB实例监听HTTPS（需要绑定数字证书），然后转发给服务器组；3）服务器组中的每台ECS，通过IP地址+端口对外提供API访问。


